# 热榜缓存系统设计文档

## 概述

热榜缓存系统是一个定时更新缓存机制，用于提高热榜接口的响应速度，减少数据库查询压力。

## 系统架构

### 核心组件

1. **LeaderboardCacheService** - 热榜缓存服务
2. **CronService** - 定时任务服务（新增热榜缓存更新任务）
3. **LeaderboardService** - 热榜服务（修改为优先从缓存读取）

### 数据流

```
定时任务 (每5分钟) → 查询数据库 → 更新Redis缓存 → 热榜接口从缓存读取
```

## 功能特性

### 1. 定时缓存更新
- **频率**: 每5分钟更新一次
- **缓存时间**: 6分钟（比更新频率多1分钟，确保数据连续性）
- **缓存内容**: 前10名用户数据 + 时间范围信息

### 2. 智能数据获取
- **优先缓存**: 热榜接口优先从Redis缓存读取数据
- **降级机制**: 缓存未命中时自动从数据库查询
- **实时用户排名**: 用户个人排名信息实时查询，不受缓存影响

### 3. 缓存数据结构

```json
{
  "week_start": "2025-01-06T00:00:00Z",
  "week_end": "2025-01-12T23:59:59Z",
  "top_users": [
    {
      "id": 1,
      "uid": "1000001",
      "username": "张**三",
      "completed_at": "2025-01-07T10:30:00Z",
      "order_count": 15,
      "total_amount": 1500.00,
      "total_profit": 150.00,
      "rank": 1,
      "is_rank": true
    }
  ],
  "next_update": "2025-01-07T10:35:00Z",
  "cache_time": "2025-01-07T10:30:00Z"
}
```

## API接口

### 热榜接口
- **路径**: `POST /api/v1/leaderboard`
- **功能**: 获取热榜数据（优先从缓存读取）
- **响应**: 包含下次更新时间

### 手动更新缓存接口
- **路径**: `POST /api/v1/cron/update-leaderboard-cache`
- **功能**: 手动触发缓存更新
- **权限**: 需要登录认证

## 配置项

### config.yaml
```yaml
fake_data:
  leaderboard_cron: "0 */5 * * * *"  # 每5分钟更新热榜缓存
```

### 环境变量
- `LEADERBOARD_CACHE_ENABLED`: 是否启用热榜缓存
- `LEADERBOARD_CACHE_CRON`: 缓存更新cron表达式

## 缓存策略

### 缓存键设计
```
leaderboard:weekly:2025-01-06
```

### 过期策略
- **TTL**: 6分钟
- **更新策略**: 定时任务每5分钟更新一次
- **容错机制**: 缓存过期后接口自动降级到数据库查询

### 数据一致性
- **时间窗口**: 使用周为单位，确保数据一致性
- **更新原子性**: 每次更新都是完整的缓存数据替换
- **版本控制**: 通过时间戳确保数据版本

## 性能优化

### 查询优化
1. **索引优化**: 确保排行榜查询使用合适的数据库索引
2. **连接池**: 使用数据库连接池减少连接开销
3. **批量查询**: 一次性查询前10名用户数据

### 缓存优化
1. **序列化**: 使用JSON序列化减少存储空间
2. **压缩**: Redis自动压缩大对象
3. **过期策略**: 合理的TTL避免内存泄漏

## 监控和日志

### 日志输出
- 缓存更新成功/失败日志
- 缓存命中/未命中统计
- 用户排名查询日志

### 关键指标
- 缓存命中率
- 缓存更新频率
- 接口响应时间
- 数据库查询次数

## 故障处理

### 缓存失效
1. **自动降级**: 缓存未命中时自动查询数据库
2. **手动更新**: 提供手动更新缓存接口
3. **监控告警**: 缓存更新失败时记录错误日志

### 数据不一致
1. **时间窗口**: 使用周为单位减少数据不一致
2. **版本控制**: 通过时间戳确保数据版本
3. **定期清理**: 定时清理过期缓存数据

## 测试验证

### 测试脚本
```bash
# 测试热榜缓存功能
./test_scripts/test_leaderboard_cache.sh
```

### 测试场景
1. **缓存命中**: 验证从缓存读取数据
2. **缓存未命中**: 验证降级到数据库查询
3. **手动更新**: 验证手动更新缓存功能
4. **定时更新**: 验证定时任务正常执行

## 部署说明

### 启动服务
```bash
# 启动服务（自动启动定时任务）
go run main.go

# 或使用Makefile
make run
```

### 验证功能
```bash
# 测试热榜接口
curl -X POST http://localhost:9001/api/v1/leaderboard \
  -H "Content-Type: application/json" \
  -d '{"uid": "1000001"}'

# 手动更新缓存
curl -X POST http://localhost:9001/api/v1/cron/update-leaderboard-cache \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 注意事项

1. **Redis依赖**: 系统依赖Redis服务，确保Redis正常运行
2. **定时任务**: 确保定时任务服务正常启动
3. **数据一致性**: 缓存数据可能与数据库有短暂不一致
4. **内存使用**: 监控Redis内存使用情况
5. **网络延迟**: 考虑Redis网络延迟对接口响应时间的影响 