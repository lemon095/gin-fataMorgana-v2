# 索引自动创建控制说明

## 概述

本项目提供了灵活的索引自动创建控制机制，可以根据需要启用或禁用索引自动创建功能。

## 控制方式

### 方法1：简单注释方式（推荐）

#### 禁用索引自动创建
在 `database/mysql.go` 文件中，找到以下代码块：

```go
// ===== 索引自动创建功能 =====
// 方法1：简单注释方式（当前使用）
// 如需禁用索引自动创建，请注释下面的代码块
/*
if err := createOptimizedIndexes(); err != nil {
    log.Printf("⚠️  创建优化索引失败: %v", err)
} else {
    log.Println("✅ 索引检测和创建完成")
}
*/
// ===== 索引自动创建功能结束 =====

// 如需启用索引自动创建，请取消注释上面的代码块，并注释下面这行
log.Println("⏭️  索引自动创建已禁用，跳过索引创建")
```

**禁用步骤：**
1. 保持上面的代码块被注释（`/* */`）
2. 保持下面的 `log.Println` 行不被注释

#### 启用索引自动创建
**启用步骤：**
1. 取消注释上面的代码块（删除 `/* */`）
2. 注释掉下面的 `log.Println` 行（在前面加 `//`）

```go
// ===== 索引自动创建功能 =====
// 方法1：简单注释方式（当前使用）
// 如需禁用索引自动创建，请注释下面的代码块
if err := createOptimizedIndexes(); err != nil {
    log.Printf("⚠️  创建优化索引失败: %v", err)
} else {
    log.Println("✅ 索引检测和创建完成")
}
// ===== 索引自动创建功能结束 =====

// 如需启用索引自动创建，请取消注释上面的代码块，并注释下面这行
// log.Println("⏭️  索引自动创建已禁用，跳过索引创建")
```

### 方法2：条件编译方式（高级）

如果需要更专业的控制方式，可以使用Go的条件编译功能。

#### 使用步骤：
1. 注释掉方法1的代码
2. 取消注释方法2的代码
3. 使用不同的编译命令控制功能

```bash
# 启用索引自动创建
go build -tags=autoindex

# 禁用索引自动创建
go build
```

## 使用场景

### 禁用索引自动创建的场景：
1. **生产环境**：生产环境通常有专门的DBA管理索引
2. **性能测试**：测试不同索引配置对性能的影响
3. **开发环境**：快速启动，不需要等待索引创建
4. **调试模式**：专注于功能调试，不需要索引优化

### 启用索引自动创建的场景：
1. **开发环境**：确保开发环境有完整的索引支持
2. **测试环境**：模拟生产环境的完整配置
3. **新项目部署**：自动创建必要的性能优化索引
4. **CI/CD流程**：自动化部署时确保索引完整性

## 注意事项

1. **手动索引管理**：禁用自动创建后，需要手动管理索引
2. **性能影响**：缺少索引可能影响查询性能
3. **手动创建索引**：可以使用 `make db-check-index` 手动创建索引
4. **索引查看**：可以使用 `make db-show-index` 查看当前索引状态

## 快速切换

### 禁用索引创建：
```bash
# 编辑 database/mysql.go，注释索引创建代码
# 然后重新编译
go build
```

### 启用索引创建：
```bash
# 编辑 database/mysql.go，取消注释索引创建代码
# 然后重新编译
go build
```

### 手动创建索引：
```bash
# 即使禁用了自动创建，仍可以手动创建
make db-check-index
```

## 日志输出

### 启用时的日志：
```
🔍 第三步：检测和创建优化索引...
索引 idx_users_uid_status_deleted_at 已存在，跳过创建
✅ 索引创建成功: idx_orders_uid_status_created_at (uid, status, created_at)
📊 索引检测完成 - 创建: 15, 跳过: 8, 失败: 0
✅ 索引检测和创建完成
```

### 禁用时的日志：
```
🔍 第三步：检测和创建优化索引...
⏭️  索引自动创建已禁用，跳过索引创建
```

## 总结

通过简单的注释方式，你可以灵活控制索引自动创建功能，满足不同环境和使用场景的需求。 