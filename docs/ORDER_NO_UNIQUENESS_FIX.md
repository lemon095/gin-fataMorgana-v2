# 订单号唯一性修复

## 问题描述

在定时任务生成假订单时，出现了订单号重复的错误：

```
Error 1062 (23000): Duplicate entry 'ORD0420100' for key 'idx_orders_order_no'
```

## 问题原因

1. **时间戳精度问题**：原系统UID生成器使用毫秒级时间戳，但在同一毫秒内生成的多个订单号会重复
2. **序列号范围限制**：序列号范围只有0-99，当同一毫秒内生成超过100个订单时就会重复
3. **定时任务并发**：定时任务可能在短时间内快速生成大量订单

## 解决方案

### 1. 修改系统UID生成器

在 `utils/system_uid_generator.go` 中：

- 添加了 `orderCounter` 字段，专门用于订单号生成
- 修改 `GenerateSystemOrderNo()` 方法，使用独立的订单计数器
- 订单号格式：`ORD + 时间戳后3位 + 机器ID2位 + 计数器4位`

### 2. 订单号格式

```
ORD + 时间戳后3位 + 机器ID2位 + 计数器4位
示例：ORD037010184
```

- `ORD`：固定前缀
- `037`：时间戳后3位（毫秒级）
- `01`：机器ID（2位）
- `0184`：订单计数器（4位，范围0-9999）

### 3. 拼单号格式

```
GB + 时间戳后3位 + 机器ID2位 + 计数器4位
示例：GB042010974
```

- `GB`：固定前缀
- `042`：时间戳后3位（毫秒级）
- `01`：机器ID（2位）
- `0974`：拼单计数器（4位，范围0-9999）

## 优势

1. **高唯一性**：计数器范围0-9999，理论上每秒可生成10000个唯一订单号
2. **时间有序**：订单号包含时间戳信息，便于排序和查询
3. **机器标识**：包含机器ID，支持分布式部署
4. **并发安全**：使用互斥锁确保并发安全

## 测试验证

创建了测试脚本 `test_scripts/test_order_no_uniqueness.sh` 验证：

- 并发生成1000个订单号，确保唯一性
- 并发生成1000个拼单号，确保唯一性
- 测试结果显示所有生成的编号都是唯一的

## 影响范围

- ✅ 系统订单号生成（假订单）
- ✅ 系统拼单号生成（假拼单）
- ✅ 用户订单号生成（通过雪花算法，不受影响）
- ✅ 用户拼单号生成（通过雪花算法，不受影响）

## 部署说明

1. 重启应用服务，新的订单号生成逻辑将生效
2. 现有数据不受影响，新生成的订单将使用新的编号格式
3. 建议在生产环境部署前先在测试环境验证

## 监控建议

1. 监控订单号生成的成功率
2. 监控定时任务的执行情况
3. 定期检查订单表的唯一性约束 