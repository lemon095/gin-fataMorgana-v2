# 错误码整理报告

## 概述
本文档总结了Gin-FataMorgana项目中错误码的统一整理工作，确保一个错误码只对应一种错误消息，并修改代码中对应的错误处理。

## 错误码体系现状

### 1. 已完成的错误码统一

#### 系统级错误码 (0-999)
- ✅ 0: 操作成功
- ✅ 1: 操作失败
- ✅ 401: 认证失败
- ✅ 403: 禁止访问
- ✅ 404: 资源不存在
- ✅ 422: 数据验证失败
- ✅ 500: 服务器内部错误

#### 数据库和缓存错误码 (1000-1999)
- ✅ 1001: 数据库操作失败
- ✅ 1002: Redis操作失败
- ✅ 1003: 参数错误
- ✅ 1004: 操作失败
- ✅ 1005: 用户不存在
- ✅ 1006: 用户已存在
- ✅ 1007: 验证失败
- ✅ 1008: 账户已被锁定
- ✅ 1009: 当前系统不允许注册
- ✅ 1010: 拼单不存在或已被删除
- ✅ 1011: 账户待审核，无法登录
- ✅ 1012: 拼单已被其他用户参与

#### 用户认证和注册错误码 (2000-2999)
- ✅ 2001: 邮箱已被注册
- ✅ 2002: 手机号已被注册
- ✅ 2003: 邮箱格式不正确
- ✅ 2004: 手机号格式不正确
- ✅ 2005: 账号不能为空
- ✅ 2006: 密码不能为空
- ✅ 2007: 两次输入的密码不一致
- ✅ 2008: 邀请码无效
- ✅ 2009: 账号不存在
- ✅ 2010: 密码错误
- ✅ 2011: 账号格式错误，请输入正确的邮箱或手机号
- ✅ 2012: 邮箱或手机号或密码错误
- ✅ 2013: 账户已被删除，无法登录
- ✅ 2014: 账户已被禁用，无法登录
- ✅ 2015: 无效的刷新令牌
- ✅ 2016: 账户已被删除，无法刷新令牌
- ✅ 2017: 账户已被禁用，无法刷新令牌
- ✅ 2018: 账户待审核，无法刷新令牌
- ✅ 2019: 用户已被删除
- ✅ 2020: 账户已被删除，无法绑定银行卡
- ✅ 2021: 账户已被禁用，无法绑定银行卡
- ✅ 2022: 卡类型不能为空
- ✅ 2023: 卡类型不正确，支持的类型：借记卡、信用卡、储蓄卡
- ✅ 2024: 用户未绑定银行卡
- ✅ 2025: 用户已被删除，无法修改密码
- ✅ 2026: 账户已被禁用，无法修改密码
- ✅ 2027: 当前密码错误
- ✅ 2028: 新密码不能与当前密码相同
- ✅ 2029: 密码长度不能少于6位
- ✅ 2030: 密码长度不能超过50位
- ✅ 2031: 邀请码无效或管理员账户已被禁用
- ✅ 2032: 邀请码对应的管理员账户已被禁用

#### 业务逻辑错误码 (3000-3999)
- ✅ 3001: 余额不足
- ✅ 3002: 拼单已满员
- ✅ 3003: 拼单已过期
- ✅ 3004: 订单金额不匹配
- ✅ 3005: 提现金额超限
- ✅ 3006: 状态类型参数无效，必须是1(进行中)、2(已完成)或3(拼单数据)
- ✅ 3007: 无权访问此订单
- ✅ 3008: 订单金额必须大于0
- ✅ 3009: 利润金额不能为负数
- ✅ 3010: 至少需要有一个任务数量大于0
- ✅ 3011: 任务数量不能为负数
- ✅ 3012: 钱包已被冻结，无法创建订单
- ✅ 3013: 钱包已被冻结，无法充值
- ✅ 3014: 充值金额必须大于0
- ✅ 3015: 单笔充值金额不能超过100万元
- ✅ 3016: 钱包已被冻结，无法提现
- ✅ 3017: 提现金额必须大于0
- ✅ 3018: 单笔提现金额不能超过100万元
- ✅ 3019: 请先绑定银行卡后再进行提现操作
- ✅ 3020: 登录密码错误
- ✅ 3021: 超过每日提现限额
- ✅ 3022: 期数不存在
- ✅ 3023: 期数还未开始
- ✅ 3024: 期数已结束
- ✅ 3025: 您已经购买过期号的订单

#### 银行卡相关错误码 (4000-4999)
- ✅ 4001: 银行卡号长度不正确，应为13-19位
- ✅ 4002: 银行卡号只能包含数字
- ✅ 4003: 持卡人姓名不能为空
- ✅ 4004: 持卡人姓名长度应在2-50个字符之间
- ✅ 4005: 持卡人姓名只能包含中文、英文字母和空格
- ✅ 4006: 银行名称不能为空
- ✅ 4007: 银行名称长度应在2-50个字符之间

#### Token相关错误码 (5000-5999)
- ✅ 5001: token验证失败
- ✅ 5002: 您的账号已在其他设备登录，请重新登录
- ✅ 5003: 无效的令牌
- ✅ 5004: 令牌已过期

#### 系统配置错误码 (6000-6999)
- ✅ 6001: 读取配置文件失败
- ✅ 6002: 解析配置文件失败
- ✅ 6003: 配置未加载
- ✅ 6004: 数据库主机地址不能为空
- ✅ 6005: 数据库用户名不能为空
- ✅ 6006: 数据库名称不能为空
- ✅ 6007: Redis主机地址不能为空
- ✅ 6008: JWT密钥不能为空
- ✅ 6009: 连接数据库失败
- ✅ 6010: 获取数据库实例失败
- ✅ 6011: 数据库未初始化
- ✅ 6012: 数据库迁移失败
- ✅ 6013: Redis连接测试失败

#### 工具类错误码 (7000-7999)
- ✅ 7001: 无法生成唯一邀请码，请稍后重试
- ✅ 7002: 重复请求，幂等键已存在
- ✅ 7003: 记录不存在

#### 中间件错误码 (8000-8999)
- ✅ 8001: 请求过于频繁，请稍后再试
- ✅ 8002: 系统繁忙，请稍后再试
- ✅ 8003: 当前系统不允许注册

#### 服务层错误码 (9000-9999)
- ✅ 9001: 获取热榜数据失败
- ✅ 9002: 加密密码失败
- ✅ 9003: 创建用户失败
- ✅ 9004: 查询用户失败
- ✅ 9005: 银行卡信息格式错误
- ✅ 9006: 更新银行卡信息失败
- ✅ 9007: 密码加密失败
- ✅ 9008: 更新密码失败
- ✅ 9009: 获取用户信息失败
- ✅ 9010: 订单数据验证失败
- ✅ 9011: 获取钱包失败
- ✅ 9012: 扣减余额失败
- ✅ 9013: 更新钱包失败
- ✅ 9014: 创建订单失败
- ✅ 9015: 获取价格配置失败
- ✅ 9016: 获取订单列表失败
- ✅ 9017: 获取拼单列表失败
- ✅ 9018: 获取订单详情失败
- ✅ 9019: 获取订单统计失败
- ✅ 9020: 获取期数信息失败
- ✅ 9021: 解析价格配置失败
- ✅ 9022: 检查期号重复失败
- ✅ 9023: 获取用户等级信息失败
- ✅ 9024: 解析用户等级信息失败
- ✅ 9025: 序列化用户等级信息失败
- ✅ 9026: 存储用户等级信息失败
- ✅ 9027: 获取用户资金记录失败
- ✅ 9028: 用户不存在
- ✅ 9029: 用户账户已被禁用，无法创建钱包
- ✅ 9030: 创建钱包失败
- ✅ 9031: 创建交易记录失败
- ✅ 9032: 创建充值申请失败
- ✅ 9033: 创建提现申请失败
- ✅ 9034: 查询今日提现记录失败
- ✅ 9035: 查询待处理提现记录失败
- ✅ 9036: 获取交易详情失败

## 代码修改总结

### 1. 用户服务 (services/user_service.go)
- ✅ 注册功能错误处理已统一
- ✅ 登录功能错误处理已统一
- ✅ 刷新令牌功能错误处理已统一
- ✅ 获取用户信息功能错误处理已统一
- ✅ 绑定银行卡功能错误处理已统一
- ✅ 获取银行卡信息功能错误处理已统一
- ✅ 修改密码功能错误处理已统一

### 2. 订单服务 (services/order_service.go)
- ✅ 创建订单功能错误处理已统一
- ✅ 验证期数功能错误处理已统一
- ✅ 验证订单金额功能错误处理已统一
- ✅ 获取订单列表功能错误处理已统一
- ✅ 获取拼单列表功能错误处理已统一
- ✅ 获取订单详情功能错误处理已统一
- ✅ 获取订单统计功能错误处理已统一
- ✅ 获取期数列表功能错误处理已统一
- ✅ 获取价格配置功能错误处理已统一
- ✅ 检查期号重复功能错误处理已统一

### 3. 钱包服务 (services/wallet_service.go)
- ✅ 获取用户交易记录功能错误处理已统一
- ✅ 创建钱包功能错误处理已统一
- ✅ 获取钱包功能错误处理已统一
- ✅ 创建交易记录功能错误处理已统一
- ✅ 充值功能错误处理已统一
- ✅ 提现功能错误处理已统一
- ✅ 检查每日提现限额功能错误处理已统一
- ✅ 获取提现汇总信息功能错误处理已统一
- ✅ 获取交易详情功能错误处理已统一

### 4. 数据库层 (database/)
- ✅ MySQL连接错误处理已统一
- ✅ 数据库迁移错误处理已统一
- ✅ 数据库健康检查错误处理已统一
- ✅ 基础仓库错误处理已统一
- ✅ Redis连接错误处理已统一

### 5. 工具类 (utils/)
- ✅ 随机字符串生成错误处理已统一
- ✅ 邀请码生成错误处理已统一
- ✅ 幂等性检查错误处理已统一

## 错误处理最佳实践

### 1. 错误码使用原则
- 每个错误码对应一种具体的错误情况
- 错误消息应该清晰明确，便于用户理解
- 错误码应该具有层次性，便于分类管理
- 新增错误码时应该遵循现有的分类规则

### 2. 错误处理分层
- **控制器层**: 使用 `utils.ErrorWithMessage()` 返回具体错误
- **服务层**: 使用 `utils.NewAppError()` 包装底层错误
- **数据访问层**: 使用 `utils.NewAppError()` 返回基础错误
- 避免在错误消息中暴露敏感信息

### 3. 错误码命名规范
- 系统级错误码：0-999
- 数据库和缓存错误码：1000-1999
- 用户认证和注册错误码：2000-2999
- 业务逻辑错误码：3000-3999
- 银行卡相关错误码：4000-4999
- Token相关错误码：5000-5999
- 系统配置错误码：6000-6999
- 工具类错误码：7000-7999
- 中间件错误码：8000-8999
- 服务层错误码：9000-9999

## 测试验证

### 1. 错误码测试
- ✅ 用户注册错误码测试
- ✅ 用户登录错误码测试
- ✅ 订单创建错误码测试
- ✅ 钱包操作错误码测试
- ✅ 数据库连接错误码测试

### 2. 错误消息一致性测试
- ✅ 确保每个错误码只对应一种错误消息
- ✅ 验证错误消息的准确性和可读性
- ✅ 检查错误消息的国际化支持

## 后续维护

### 1. 新增错误码流程
1. 在 `utils/response.go` 中定义新的错误码常量
2. 在 `ResponseMessage` 映射中添加对应的错误消息
3. 在 `docs/ERROR_CODES.md` 中更新错误码文档
4. 在相关服务中使用新的错误码

### 2. 错误码监控
- 建立错误码使用统计
- 监控错误码的分布和频率
- 定期审查和优化错误码体系

### 3. 文档维护
- 保持错误码文档的及时更新
- 记录错误码的使用场景和示例
- 维护错误码的变更历史

## 总结

通过本次错误码整理工作，我们成功实现了：

1. **统一性**: 所有错误都使用统一的错误码和错误消息
2. **规范性**: 建立了完整的错误码分类体系
3. **可维护性**: 错误码具有清晰的层次结构和命名规范
4. **可扩展性**: 为后续功能扩展预留了足够的错误码空间
5. **用户体验**: 错误消息更加清晰明确，便于用户理解

项目中的错误处理现在更加规范、统一和易于维护，为项目的长期发展奠定了良好的基础。 