# 钱包充值和提现逻辑详解

## 概述

系统采用**双阶段**的资金操作流程，确保资金安全和操作可追溯。充值采用"申请+确认"模式，提现采用"申请+管理员确认"模式。

## 一、充值流程

### 1.1 充值申请 (Recharge)

**接口**: `POST /api/v1/wallet/recharge`

**流程**:
1. **参数验证**: 检查用户ID、充值金额、描述信息
2. **钱包检查**: 
   - 获取用户钱包信息
   - 检查钱包状态是否正常
3. **金额检查**:
   - 检查充值金额是否大于0
   - 检查是否超过单笔充值限额（100万元）
4. **生成流水号**: 生成唯一充值流水号
5. **创建交易记录**: 创建状态为 `pending` 的充值交易记录
   - 交易类型: `recharge`
   - 状态: `pending`
   - 余额不变（充值未到账）
   - 记录交易前余额和交易后余额
6. **返回流水号**: 返回充值流水号给前端

**关键特点**:
- 充值申请时**不增加钱包余额**
- 创建 `pending` 状态的交易记录
- 记录交易前后的余额变化
- **需要后续处理确认**

### 1.2 充值流程图

```
用户发起充值申请
        ↓
    检查钱包状态和金额
        ↓
    生成充值流水号
        ↓
    创建pending交易记录
        ↓
    返回流水号给用户
        ↓
    等待后续处理
```

## 二、提现流程

### 2.1 提现申请 (RequestWithdraw)

**接口**: `POST /api/v1/wallet/withdraw`

**流程**:
1. **参数验证**: 检查用户ID、提现金额、银行卡信息
2. **钱包检查**: 
   - 获取用户钱包信息
   - 检查钱包状态是否正常
3. **余额检查**:
   - 检查总余额是否足够
4. **限额检查**:
   - 单笔提现限额：100万元
   - 每日提现限额：500万元（可选）
5. **直接扣减余额**: 从总余额中直接扣减提现金额
6. **创建交易记录**: 创建状态为 `pending` 的提现交易记录
   - 交易类型: `withdraw`
   - 状态: `pending`
   - 记录银行卡信息到备注字段
   - 记录交易前余额和交易后余额
7. **返回流水号**: 返回提现流水号

**关键特点**:
- 申请时**直接扣减余额**，不冻结金额
- 创建 `pending` 状态的交易记录
- 记录交易前后的余额变化
- **需要后续处理确认**

### 2.2 提现流程图

```
用户发起提现申请
        ↓
    检查余额和限额
        ↓
    直接扣减余额
        ↓
    创建pending交易记录
        ↓
    返回流水号给用户
        ↓
    等待后续处理
```

## 三、余额管理机制

### 3.1 余额结构

```go
type Wallet struct {
    Balance       float64 // 总余额
    FrozenBalance float64 // 冻结余额
    // 可用余额 = 总余额 - 冻结余额
}
```

### 3.2 余额操作

| 操作类型 | 总余额 | 冻结余额 | 可用余额 | 说明 |
|----------|--------|----------|----------|------|
| 充值申请 | 不变 | 不变 | 不变 | 创建pending记录，需要后续处理 |
| 提现申请 | -金额 | 不变 | -金额 | 直接扣减余额，申请即成功 |

### 3.3 安全机制

1. **余额检查**: 每次操作前检查余额是否足够
2. **状态检查**: 确保交易状态正确
3. **幂等性**: 重复操作不会产生副作用
4. **事务性**: 钱包更新和交易记录创建在同一事务中
5. **审计追踪**: 记录所有操作的详细信息和操作员

## 四、交易状态说明

### 4.1 交易状态枚举

```go
const (
    TransactionStatusPending   = "pending"   // 待处理
    TransactionStatusSuccess   = "success"   // 成功
    TransactionStatusFailed    = "failed"    // 失败
    TransactionStatusCancelled = "cancelled" // 已取消
)
```

### 4.2 状态流转

**充值状态流转**:
```
pending → success
```

**提现状态流转**:
```
pending → success (确认)
pending → cancelled (取消)
```

## 五、接口权限

### 5.1 用户接口
- `POST /api/v1/wallet/recharge-apply` - 充值申请
- `POST /api/v1/wallet/withdraw` - 提现申请
- `POST /api/v1/wallet/info` - 获取钱包信息
- `POST /api/v1/wallet/transactions` - 获取交易记录

### 5.2 管理员接口
- `POST /api/v1/wallet/recharge-confirm` - 充值确认
- `POST /api/v1/admin/withdraw/confirm` - 提现确认
- `POST /api/v1/admin/withdraw/cancel` - 提现取消

## 六、错误处理

### 6.1 常见错误
- **余额不足**: 可用余额小于申请金额
- **状态错误**: 交易状态不符合预期
- **类型错误**: 交易类型不匹配
- **限额超限**: 超过单笔或每日限额

### 6.2 异常处理
- **网络异常**: 自动重试机制
- **数据库异常**: 事务回滚
- **并发操作**: 乐观锁机制

## 七、监控和审计

### 7.1 监控指标
- 充值成功率
- 提现处理时间
- 异常交易数量
- 余额变化趋势

### 7.2 审计日志
- 所有资金操作记录
- 操作员信息
- IP地址和时间戳
- 操作前后的余额变化 