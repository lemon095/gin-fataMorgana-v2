# 银行卡绑定API文档

## 概述

银行卡绑定功能允许用户绑定银行卡信息，用于提现等操作。银行卡信息以JSON格式存储在用户表的 `bank_card_info` 字段中。

**🔍 重要特性：**
- ✅ **Luhn算法校验** - 验证银行卡号的有效性
- ✅ **BIN码验证** - 验证银行卡前6位是否属于已知银行
- ✅ **格式验证** - 严格的输入格式验证
- ✅ **安全存储** - JSON格式存储，便于扩展

## API接口

### 1. 绑定银行卡

**接口地址：** `POST /api/bind-bank-card`

**请求参数：**
```json
{
  "uid": "12345678",
  "bank_name": "招商银行",
  "card_holder": "张三",
  "card_number": "6225881234567890",
  "card_type": "借记卡"
}
```

**参数说明：**
- `uid` (必需) - 用户唯一ID
- `bank_name` (必需) - 银行名称（2-50个字符，只允许中文、英文、数字、空格）
- `card_holder` (必需) - 持卡人姓名（2-20个字符，只允许中文、英文、空格）
- `card_number` (必需) - 银行卡号（13-19位数字，通过Luhn算法校验）
- `card_type` (必需) - 卡类型（借记卡、信用卡、储蓄卡）

**响应示例：**
```json
{
  "code": 0,
  "message": "银行卡绑定成功",
  "data": {
    "user": {
      "id": 1,
      "uid": "12345678",
      "username": "user_abc123",
      "email": "user@example.com",
      "phone": "",
      "bank_card_info": "{\"card_number\":\"6225881234567890\",\"card_type\":\"借记卡\",\"bank_name\":\"招商银行\",\"card_holder\":\"张三\"}",
      "experience": 0,
      "credit_score": 100,
      "status": 1,
      "invited_by": "",
      "has_group_buy_qualification": false,
      "created_at": "2024-12-01T10:00:00Z"
    }
  }
}
```

### 2. 获取银行卡信息

**接口地址：** `GET /api/bank-card-info?uid=12345678`

**请求参数：**
- `uid` (必需) - 用户唯一ID

**响应示例：**
```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "bank_card_info": {
      "card_number": "6225881234567890",
      "card_type": "借记卡",
      "bank_name": "招商银行",
      "card_holder": "张三"
    }
  }
}
```

## 支持的卡类型

| 卡类型 | 说明 |
|--------|------|
| 借记卡 | 借记卡 |
| 信用卡 | 信用卡 |
| 储蓄卡 | 储蓄卡 |

## 银行卡校验规则

### 🔢 银行卡号校验

#### 1. 基本格式验证
- **长度要求**：13-19位数字
- **字符要求**：只能包含数字
- **空格处理**：自动去除空格

#### 2. Luhn算法校验
使用Luhn算法验证银行卡号的有效性：

```go
// Luhn算法示例
卡号：6225 8812 3456 7890
步骤：
1. 从右到左，偶数位数字乘以2
2. 如果乘积大于9，则减去9
3. 所有数字相加
4. 如果总和能被10整除，则卡号有效
```

#### 3. BIN码验证
验证银行卡前6位是否属于已知银行：

| BIN码范围 | 银行名称 |
|-----------|----------|
| 622200-622995 | 工商银行 |
| 436742-436799 | 建设银行 |
| 622848-622899 | 农业银行 |
| 456351-456399 | 中国银行 |
| 622580-622599 | 招商银行 |
| 622250-622299 | 交通银行 |

### 👤 持卡人姓名校验

- **长度要求**：2-20个字符
- **字符要求**：只允许中文、英文、空格
- **空格处理**：自动去除首尾空格

### 🏦 银行名称校验

- **长度要求**：2-50个字符
- **字符要求**：只允许中文、英文、数字、空格
- **空格处理**：自动去除首尾空格

## 验证规则

### 银行卡信息验证

1. **银行名称** - 2-50个字符，只允许中文、英文、数字、空格
2. **持卡人姓名** - 2-20个字符，只允许中文、英文、空格
3. **银行卡号** - 13-19位数字，通过Luhn算法校验
4. **卡类型** - 必须是支持的类型之一

### 用户状态验证

1. **用户存在性** - 用户必须存在
2. **账户状态** - 用户账户不能已被删除或禁用

## 错误处理

### 常见错误码

| 错误码 | 说明 | HTTP状态码 |
|--------|------|------------|
| 1000 | 参数错误 | 400 |
| 1001 | 数据验证失败 | 400 |
| 2004 | 用户不存在 | 401 |
| 2009 | 账户已被锁定 | 401 |
| 3000 | 操作失败 | 422 |

### 错误响应示例

**银行卡号校验失败：**
```json
{
  "code": 1001,
  "message": "银行卡号校验失败，请检查卡号是否正确",
  "data": null
}
```

**银行卡号格式错误：**
```json
{
  "code": 1001,
  "message": "银行卡号只能包含数字",
  "data": null
}
```

**持卡人姓名格式错误：**
```json
{
  "code": 1001,
  "message": "持卡人姓名只能包含中文、英文和空格",
  "data": null
}
```

**银行名称格式错误：**
```json
{
  "code": 1001,
  "message": "银行名称只能包含中文、英文、数字和空格",
  "data": null
}
```

## 数据存储

银行卡信息以JSON格式存储在用户表的 `bank_card_info` 字段中：

```json
{
  "card_number": "6225881234567890",
  "card_type": "借记卡",
  "bank_name": "招商银行",
  "card_holder": "张三"
}
```

## 业务逻辑

### 绑定流程

1. 验证用户存在性和状态
2. 验证银行卡信息格式（银行名称、持卡人姓名、银行卡号、卡类型）
3. 执行Luhn算法校验银行卡号
4. 验证BIN码是否属于已知银行
5. 将银行卡信息转换为JSON格式
6. 更新用户表中的 `bank_card_info` 字段
7. 返回更新后的用户信息

### 更新机制

- 如果用户已绑定银行卡，再次调用绑定接口会覆盖原有信息
- 每次绑定都会更新 `updated_at` 字段

### 安全考虑

1. **数据验证** - 严格验证输入参数
2. **Luhn算法** - 国际标准的银行卡号校验算法
3. **BIN码验证** - 验证银行卡所属银行
4. **用户状态检查** - 确保只有正常状态的用户才能绑定
5. **JSON格式存储** - 便于扩展和维护
6. **错误处理** - 完整的错误处理和响应

## 使用示例

### 绑定银行卡

```bash
curl -X POST "http://localhost:8080/api/bind-bank-card" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{
    "uid": "12345678",
    "bank_name": "招商银行",
    "card_holder": "张三",
    "card_number": "6225881234567890",
    "card_type": "借记卡"
  }'
```

### 获取银行卡信息

```bash
curl -X GET "http://localhost:8080/api/bank-card-info?uid=12345678" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

## 测试脚本

### 基础功能测试
使用 `test_bank_card.sh` 脚本进行基础功能测试：

```bash
./test_bank_card.sh
```

### 校验功能测试
使用 `test_bank_card_validation.sh` 脚本进行校验功能测试：

```bash
./test_bank_card_validation.sh
```

测试内容包括：
- ✅ 成功绑定银行卡
- ✅ Luhn算法校验
- ✅ BIN码验证
- ✅ 各种参数验证错误
- ✅ 格式验证
- ✅ 长度验证
- ✅ 字符验证
- ✅ 空格处理
- ✅ 用户不存在的情况
- ✅ 银行卡信息更新

## 注意事项

1. **银行卡号校验** - 使用Luhn算法确保卡号有效性
2. **BIN码验证** - 支持主要银行的BIN码验证
3. **格式严格** - 严格的输入格式验证，防止恶意输入
4. **自动处理** - 自动去除多余空格，提升用户体验
5. **安全存储** - JSON格式存储，便于后续扩展
6. **完整测试** - 提供完整的测试脚本覆盖各种场景
7. **错误友好** - 详细的错误信息，便于问题定位
8. **与提现集成** - 提现时会使用绑定的银行卡信息 