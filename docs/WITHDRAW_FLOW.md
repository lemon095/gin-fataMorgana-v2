# 提现流程API文档

## 概述

用户提现采用申请-审核-确认的流程，确保资金安全：

1. **用户申请提现** - 锁定提现金额，创建待处理交易记录
2. **后台审核处理** - 系统自动或人工审核提现申请
3. **确认或取消** - 根据审核结果确认提现或取消申请

## API接口

### 1. 申请提现

**接口地址：** `POST /api/wallet/request-withdraw`

**请求参数：**
```json
{
  "uid": "12345678",
  "amount": 100.00,
  "description": "提现到银行卡",
  "bank_card_info": "招商银行 6225****1234 张三"
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "transaction_no": "TX202412011234567890",
    "amount": 100.00,
    "status": "pending",
    "message": "提现申请已提交，等待处理"
  }
}
```

**业务逻辑：**
- 检查钱包状态和可用余额
- 锁定提现金额（冻结余额）
- 创建待处理的交易记录
- 返回交易流水号

### 2. 确认提现（后台管理）

**接口地址：** `POST /api/wallet/confirm-withdraw`

**请求参数：**
```json
{
  "transaction_no": "TX202412011234567890"
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "提现确认成功",
  "data": null
}
```

**业务逻辑：**
- 验证交易记录状态（必须是pending）
- 减少冻结余额（解冻金额）
- 减少总余额（扣减金额）
- 更新交易记录状态为success
- 更新交易记录的余额和冻结余额字段

### 3. 取消提现（后台管理）

**接口地址：** `POST /api/wallet/cancel-withdraw`

**请求参数：**
```json
{
  "transaction_no": "TX202412011234567890",
  "reason": "银行卡信息有误"
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "提现取消成功",
  "data": null
}
```

**业务逻辑：**
- 验证交易记录状态（必须是pending）
- 只减少冻结余额（解冻金额），不扣减总余额
- 更新交易记录状态为cancelled
- 更新交易记录的余额和冻结余额字段
- 记录取消原因到备注字段

### 4. 获取交易记录

**接口地址：** `GET /api/wallet/transactions?uid=12345678&page=1&page_size=10`

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "transactions": [
      {
        "id": 1,
        "transaction_no": "TX202412011234567890",
        "uid": "12345678",
        "type": "withdraw",
        "type_name": "提现",
        "amount": 100.00,
        "balance_before": 500.00,
        "balance_after": 400.00,
        "frozen_before": 0.00,
        "frozen_after": 0.00,
        "status": "success",
        "status_name": "成功",
        "description": "提现到银行卡",
        "remark": "招商银行 6225****1234 张三",
        "operator_uid": "system",
        "created_at": "2024-12-01T12:34:56Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 10,
      "total": 1,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    }
  }
}
```

## 交易状态说明

| 状态 | 说明 | 总余额变化 | 冻结余额变化 | 可用余额变化 |
|------|------|------------|--------------|--------------|
| pending | 待处理 | 不变 | +提现金额 | -提现金额 |
| success | 成功 | -提现金额 | -提现金额 | 不变 |
| failed | 失败 | 不变 | -提现金额 | +提现金额 |
| cancelled | 已取消 | 不变 | -提现金额 | +提现金额 |

## 业务流程

### 正常提现流程
1. 用户申请提现 → 状态：pending
2. 后台确认提现 → 状态：success
3. 资金到账

### 取消提现流程
1. 用户申请提现 → 状态：pending
2. 后台取消提现 → 状态：cancelled
3. 冻结金额解冻

### 异常处理
- 余额不足：直接返回错误，不创建交易记录
- 钱包冻结：直接返回错误，不创建交易记录
- 系统异常：自动回滚冻结金额

## 安全考虑

1. **金额锁定**：申请提现时立即锁定金额，防止重复提现
2. **状态验证**：每次操作都验证交易状态，防止重复处理
3. **余额检查**：严格检查可用余额，确保资金安全
4. **操作记录**：完整记录所有操作，便于审计
5. **异常回滚**：系统异常时自动回滚，保证数据一致性

## 测试脚本

- `test_withdraw_flow.sh` - 用户提现申请测试
- `test_admin_withdraw.sh` - 后台提现管理测试

## 注意事项

1. 用户只能申请提现，不能直接提现
2. 后台会自动处理提现逻辑（确认或取消）
3. 确认提现后，冻结金额会被扣减
4. 取消提现后，冻结金额会被解冻
5. 所有操作都有完整的审计日志

## 余额检查和处理逻辑

### 余额检查机制

系统在申请提现时会进行多层余额检查：

1. **总余额检查** - 确保用户有足够的资金
2. **可用余额检查** - 考虑已冻结的金额
3. **单笔限额检查** - 防止单笔提现过大
4. **每日限额检查** - 防止每日提现过多

### 多笔提现申请处理

用户可以同时申请多笔提现，系统会：

1. **累计冻结金额** - 每笔申请都会冻结相应金额
2. **实时余额检查** - 每次申请都检查可用余额
3. **独立处理** - 每笔申请独立处理，互不影响

### 错误处理场景

| 场景 | 错误信息 | 处理方式 |
|------|----------|----------|
| 提现金额 <= 0 | "提现金额必须大于0" | 拒绝申请 |
| 总余额不足 | "总余额不足，当前总余额: X，申请提现: Y" | 拒绝申请 |
| 可用余额不足 | "可用余额不足，当前可用余额: X，已冻结金额: Y，申请提现: Z" | 拒绝申请 |
| 超过单笔限额 | "单笔提现金额不能超过100万元" | 拒绝申请 |
| 超过每日限额 | "超过每日提现限额，今日已申请: X，本次申请: Y，每日限额: Z" | 拒绝申请 |
| 钱包冻结 | "钱包已被冻结，无法提现" | 拒绝申请 |

### 余额计算示例

**初始状态：**
- 总余额：1000元
- 冻结余额：0元
- 可用余额：1000元

**申请提现300元：**
- 总余额：1000元（不变）
- 冻结余额：300元（+300）
- 可用余额：700元（-300）

**再申请提现200元：**
- 总余额：1000元（不变）
- 冻结余额：500元（+200）
- 可用余额：500元（-200）

**再申请提现600元：**
- 失败：可用余额不足（只有500元）

### 新增接口

#### 获取提现汇总信息

**接口地址：** `GET /api/wallet/withdraw-summary?uid=12345678`

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "wallet_info": {
      "total_balance": 1000.00,
      "frozen_balance": 500.00,
      "available_balance": 500.00
    },
    "today_withdraw": {
      "pending_total": 500.00,
      "success_total": 0.00,
      "cancelled_total": 0.00,
      "pending_count": 2,
      "success_count": 0,
      "cancelled_count": 0
    },
    "total_pending": {
      "amount": 500.00,
      "count": 2
    },
    "limits": {
      "single_limit": 1000000.0,
      "daily_limit": 5000000.0,
      "remaining_today": 4500000.0
    }
  }
}
```

**返回信息说明：**
- `wallet_info`: 钱包基本信息
- `today_withdraw`: 今日提现统计
- `total_pending`: 所有待处理提现统计
- `limits`: 提现限额信息 